name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: read

jobs:
  ci:
    name: Lint → Start Server → E2E → Build → Scan
    runs-on: ubuntu-latest
    env:
      HEALTH_URL: http://localhost:3000/health
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js 24
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}

      - name: Install dependencies
        run: npm ci

      - name: Run linter (if present)
        run: |
          if node -e "process.exit(require('./package.json').scripts && require('./package.json').scripts['lint'] ? 0 : 1)"; then
            npm run lint
          else
            echo "No lint script, skipping."
          fi

      - name: Run unit tests (if present)
        run: |
          if node -e "process.exit(require('./package.json').scripts && require('./package.json').scripts['test'] ? 0 : 1)"; then
            npm test
          else
            echo "No test script, skipping."
          fi

      - name: Start server in background
        id: start-server
        run: |
          # Prefer npm start if present otherwise run src/index.ts directly
          if node -e "process.exit(require('./package.json').scripts && require('./package.json').scripts['start'] ? 0 : 1)"; then
            npm run start &>/tmp/server.log &
            echo "started-via-npm" > /tmp/server-start-mode
          else
            # run node directly with the experimental flag (matches your dev script)
            node --experimental-transform-types src/index.ts &>/tmp/server.log &
            echo "started-via-node" > /tmp/server-start-mode
          fi
          echo "server_pid=$!" >> $GITHUB_OUTPUT
      - name: Wait for server /health
        run: |
          # install wait-on to wait for the health endpoint
          npx wait-on --timeout 120000 ${{ env.HEALTH_URL }}
          echo "health ok"

      - name: Show server logs (tail)
        run: tail -n +1 /tmp/server.log || true

      - name: Run E2E orchestration (runs scripts/run-e2e.ts)
        run: |
          # The orchestration script itself starts and waits for the server and runs the TS e2e tests.
          # Ensure required dependencies available.
          node --experimental-transform-types scripts/run-e2e.ts
        timeout-minutes: 20

      - name: Save E2E artifacts (if created)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-logs
          path: |
            test-artifacts/**
            /tmp/server.log

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Detect Dockerfile path
        id: detect-dockerfile
        run: |
          DF=""
          if [ -f docker/Dockerfile.prod ]; then DF="docker/Dockerfile.prod"
          elif [ -f docker/Dockerfile ]; then DF="docker/Dockerfile"
          elif [ -f Dockerfile ]; then DF="Dockerfile"
          fi
          echo "dockerfile=$DF" >> $GITHUB_OUTPUT

      - name: Build Docker image (no push)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ steps.detect-dockerfile.outputs.dockerfile }}
          push: false
          tags: ci-build:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Scan Docker image with Trivy
        uses: aquasecurity/trivy-action@v0.10.1
        with:
          image-ref: ci-build:${{ github.sha }}
          format: table
          exit-code: "1" # set to "0" if you want only warnings
