name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  prepare:
    name: Prepare & detect environment
    runs-on: ubuntu-latest
    outputs:
      pkg_exists: ${{ steps.check_pkg.outputs.pkg_exists }}
      dockerfile: ${{ steps.detect_dockerfile.outputs.dockerfile }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - id: check_pkg
        name: Detect package.json at repo root
        run: |
          if [ -f package.json ]; then echo "pkg_exists=true" >> $GITHUB_OUTPUT; else echo "pkg_exists=false" >> $GITHUB_OUTPUT; fi

      - id: detect_dockerfile
        name: Detect Dockerfile path
        run: |
          DF=""
          if [ -f docker/Dockerfile.prod ]; then DF="docker/Dockerfile.prod"
          elif [ -f docker/Dockerfile ]; then DF="docker/Dockerfile"
          elif [ -f Dockerfile ]; then DF="Dockerfile"
          elif [ -f docker/Dockerfile.dev ]; then DF="docker/Dockerfile.dev"
          fi
          echo "dockerfile=$DF" >> $GITHUB_OUTPUT

  lint_and_test:
    name: Lint, Format check, Tests
    runs-on: ubuntu-latest
    needs: prepare
    if: always() # run to allow skipping gracefully
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js  – use node only if package.json present
        if: ${{ needs.prepare.outputs.pkg_exists == 'true' }}
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Cache npm (optional)
        if: ${{ needs.prepare.outputs.pkg_exists == 'true' }}
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}

      - name: Install dependencies
        if: ${{ needs.prepare.outputs.pkg_exists == 'true' }}
        run: npm ci

      - name: Run lint if script exists
        if: ${{ needs.prepare.outputs.pkg_exists == 'true' }}
        run: |
          node -e "console.log(require('./package.json').scripts && require('./package.json').scripts['lint'] ? 'has' : 'none')"
          if node -e "process.exit(require('./package.json').scripts && require('./package.json').scripts['lint'] ? 0 : 1)"; then
            npm run lint
          else
            echo "No lint script found — skipping"
          fi

      - name: Run format:check if script exists
        if: ${{ needs.prepare.outputs.pkg_exists == 'true' }}
        run: |
          if node -e "process.exit(require('./package.json').scripts && require('./package.json').scripts['format:check'] ? 0 : 1)"; then
            npm run format:check
          else
            echo "No format:check script found — skipping"
          fi

      - name: Run E2E tests if script exists
        if: ${{ needs.prepare.outputs.pkg_exists == 'true' }}
        run: |
          if node -e "process.exit(require('./package.json').scripts && require('./package.json').scripts['test:e2e'] ? 0 : 1)"; then
            mkdir -p test-artifacts
            npm run test:e2e 2>&1 | tee test-artifacts/e2e.log
            echo "Uploading artifacts..."
            ls -la test-artifacts || true
          else
            echo "No test:e2e script found — skipping"
          fi

      - name: Upload E2E logs (if any)
        if: ${{ always() && (needs.prepare.outputs.pkg_exists == 'true') }}
        uses: actions/upload-artifact@v4
        with:
          name: e2e-logs
          path: test-artifacts/**

  build_image:
    name: Build Docker image (local)
    runs-on: ubuntu-latest
    needs: [prepare, lint_and_test]
    outputs:
      image_ref: build-image-ref
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Determine Dockerfile
        id: detect
        run: |
          DF="${{ needs.prepare.outputs.dockerfile }}"
          if [ -z "$DF" ]; then
            echo "No Dockerfile detected in standard paths (docker/Dockerfile.prod, docker/Dockerfile, Dockerfile). Aborting build."
            exit 1
          fi
          echo "dockerfile=$DF" >> $GITHUB_OUTPUT

      - name: Build image (no push)
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ steps.detect.outputs.dockerfile }}
          push: false
          tags: "local-build:${{ github.sha }}"
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Set image ref output
        run: echo "image_ref=local-build:${GITHUB_SHA}" >> $GITHUB_OUTPUT

      - name: Scan Docker image with Trivy
        uses: aquasecurity/trivy-action@v0.10.1
        with:
          image-ref: "local-build:${{ github.sha }}"
          format: table
          exit-code: "1" # fail CI when vulnerabilities found; change to "0" to only warn


