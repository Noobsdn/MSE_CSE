name: CI (E2E + build + scan) - Safe debug

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: read
  actions: read

jobs:
  ci:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      HEALTH_URL: http://localhost:3000/health

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show repo files (debug)
        run: |
          echo "Top-level files:"
          ls -la
          echo "docker folder contents (if present):"
          ls -la docker || true

      - name: Setup Node 24
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Install deps
        run: npm ci

      - name: Print package.json scripts (debug)
        run: node -e "console.log(JSON.stringify(require('./package.json').scripts || {}, null, 2))"

      - name: Build (if needed)
        run: |
          if node -e "process.exit(require('./package.json').scripts && require('./package.json').scripts['build'] ? 0 : 1)"; then
            echo "Running npm run build"
            npm run build
          else
            echo "No build script found - skipping"
          fi

      - name: Start server in background and tail logs
        run: |
          echo "Starting server..."
          if node -e "process.exit(require('./package.json').scripts && require('./package.json').scripts['start'] ? 0 : 1)"; then
            npm run start &> /tmp/server.log &
          else
            node --experimental-transform-types src/index.ts &> /tmp/server.log &
          fi
          sleep 1
          echo "Server PID: $!"
          tail -n +1 /tmp/server.log || true

      - name: Wait for /health to respond
        run: |
          npx wait-on --timeout 120000 ${{ env.HEALTH_URL }}

      - name: Show server log snapshot
        run: tail -n 200 /tmp/server.log || true

      - name: Run E2E orchestration if scripts present
        run: |
          if [ -f scripts/run-e2e.ts ]; then
            node --experimental-transform-types scripts/run-e2e.ts
          else
            echo "No scripts/run-e2e.ts; skipping E2E orchestration"
          fi
        timeout-minutes: 20

      - name: Upload server log artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: server-log
          path: /tmp/server.log

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up buildx
        uses: docker/setup-buildx-action@v3

      - name: Detect Dockerfile path (debug)
        id: detect-df
        run: |
          DF=""
          for p in docker/Dockerfile.prod docker/Dockerfile Dockerfile docker/Dockerfile.dev; do
            if [ -f "$p" ]; then DF="$p"; break; fi
          done
          echo "Detected Dockerfile=$DF"
          echo "dockerfile=$DF" >> $GITHUB_OUTPUT

      - name: Print Dockerfile (debug)
        run: |
          echo "Dockerfile path: ${{ steps.detect-df.outputs.dockerfile }}"
          if [ -n "${{ steps.detect-df.outputs.dockerfile }}" ]; then
            sed -n '1,200p' "${{ steps.detect-df.outputs.dockerfile }}"
          else
            echo "No Dockerfile found"
          fi

      - name: Build Docker image (no push)
        if: ${{ steps.detect-df.outputs.dockerfile != '' }}
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ steps.detect-df.outputs.dockerfile }}
          push: false
          tags: safe-ci:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Run Trivy (warn-only)
        if: ${{ steps.detect-df.outputs.dockerfile != '' }}
        uses: aquasecurity/trivy-action@v0.10.1
        with:
          image-ref: safe-ci:${{ github.sha }}
          format: table
          exit-code: "0"
